/*! Collection - v0.1.1 - 2014-12-13
* https://github.com/i5ting/Collection.js
* Copyright (c) 2014 alfred sang; Licensed MIT */
this.JSON||(this.JSON={}),function(){function f(a){return 10>a?"0"+a:a}function quote(a){return escapable.lastIndex=0,escapable.test(a)?'"'+a.replace(escapable,function(a){var b=meta[a];return"string"==typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function str(a,b){var c,d,e,f,g,h=gap,i=b[a];switch(i&&"object"==typeof i&&"function"==typeof i.toJSON&&(i=i.toJSON(a)),"function"==typeof rep&&(i=rep.call(b,a,i)),typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";if(gap+=indent,g=[],"[object Array]"===Object.prototype.toString.apply(i)){for(f=i.length,c=0;f>c;c+=1)g[c]=str(c,i)||"null";return e=0===g.length?"[]":gap?"[\n"+gap+g.join(",\n"+gap)+"\n"+h+"]":"["+g.join(",")+"]",gap=h,e}if(rep&&"object"==typeof rep)for(f=rep.length,c=0;f>c;c+=1)d=rep[c],"string"==typeof d&&(e=str(d,i),e&&g.push(quote(d)+(gap?": ":":")+e));else for(d in i)Object.hasOwnProperty.call(i,d)&&(e=str(d,i),e&&g.push(quote(d)+(gap?": ":":")+e));return e=0===g.length?"{}":gap?"{\n"+gap+g.join(",\n"+gap)+"\n"+h+"}":"{"+g.join(",")+"}",gap=h,e}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(a,b,c){var d;if(gap="",indent="","number"==typeof c)for(d=0;c>d;d+=1)indent+=" ";else"string"==typeof c&&(indent=c);if(rep=b,!b||"function"==typeof b||"object"==typeof b&&"number"==typeof b.length)return str("",{"":a});throw new Error("JSON.stringify")}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(a,b){var c,d,e=a[b];if(e&&"object"==typeof e)for(c in e)Object.hasOwnProperty.call(e,c)&&(d=walk(e,c),void 0!==d?e[c]=d:delete e[c]);return reviver.call(a,b,e)}var j;if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),function(a){function b(){try{return g in a&&a[g]}catch(b){return!1}}function c(a){return a.replace(/^d/,"___$&").replace(m,"___")}var d,e={},f=a.document,g="localStorage",h="script";if(e.disabled=!1,e.version="1.3.17",e.set=function(){},e.get=function(){},e.has=function(a){return void 0!==e.get(a)},e.remove=function(){},e.clear=function(){},e.transact=function(a,b,c){null==c&&(c=b,b=null),null==b&&(b={});var d=e.get(a,b);c(d),e.set(a,d)},e.getAll=function(){},e.forEach=function(){},e.serialize=function(a){return JSON.stringify(a)},e.deserialize=function(a){if("string"!=typeof a)return void 0;try{return JSON.parse(a)}catch(b){return a||void 0}},b())d=a[g],e.set=function(a,b){return void 0===b?e.remove(a):(d.setItem(a,e.serialize(b)),b)},e.get=function(a,b){var c=e.deserialize(d.getItem(a));return void 0===c?b:c},e.remove=function(a){d.removeItem(a)},e.clear=function(){d.clear()},e.getAll=function(){var a={};return e.forEach(function(b,c){a[b]=c}),a},e.forEach=function(a){for(var b=0;b<d.length;b++){var c=d.key(b);a(c,e.get(c))}};else if(f.documentElement.addBehavior){var i,j;try{j=new ActiveXObject("htmlfile"),j.open(),j.write("<"+h+">document.w=window</"+h+'><iframe src="/favicon.ico"></iframe>'),j.close(),i=j.w.frames[0].document,d=i.createElement("div")}catch(k){d=f.createElement("div"),i=f.body}var l=function(a){return function(){var b=Array.prototype.slice.call(arguments,0);b.unshift(d),i.appendChild(d),d.addBehavior("#default#userData"),d.load(g);var c=a.apply(e,b);return i.removeChild(d),c}},m=new RegExp("[!\"#$%&'()*+,/\\\\:;<=>?@[\\]^`{|}~]","g");e.set=l(function(a,b,d){return b=c(b),void 0===d?e.remove(b):(a.setAttribute(b,e.serialize(d)),a.save(g),d)}),e.get=l(function(a,b,d){b=c(b);var f=e.deserialize(a.getAttribute(b));return void 0===f?d:f}),e.remove=l(function(a,b){b=c(b),a.removeAttribute(b),a.save(g)}),e.clear=l(function(a){var b=a.XMLDocument.documentElement.attributes;a.load(g);for(var c,d=0;c=b[d];d++)a.removeAttribute(c.name);a.save(g)}),e.getAll=function(){var a={};return e.forEach(function(b,c){a[b]=c}),a},e.forEach=l(function(a,b){for(var c,d=a.XMLDocument.documentElement.attributes,f=0;c=d[f];++f)b(c.name,e.deserialize(a.getAttribute(c.name)))})}try{var n="__storejs__";e.set(n,n),e.get(n)!=n&&(e.disabled=!0),e.remove(n)}catch(k){e.disabled=!0}e.enabled=!e.disabled,"undefined"!=typeof module&&module.exports&&this.module!==module?module.exports=e:"function"==typeof define&&define.amd?define(e):a.store=e}(Function("return this")()),Class("CollectionBase",{config:function(){return ichat_config},exec_sql:function(a){this.config().exec_sql(a)}}),Class("StorageBase",{constructor:function(){},debug:!0,check_if_not_support:function(){this.log("暂时未实现")},log:function(a){1==this.debug&&console.log("[LocalStore LOG] "+a)},dump:function(a){1==debug&&console.log("[LocalStore Dump] "+a)},_add:function(a){return 1==this.check_if_exist()?(console.log("重复不能添加"),void 0):(this.content_arr.push(a),void 0)},_add_force:function(){this.log("暂时未实现")},check_if_exist:function(){return this.log("暂时未实现"),!0},add_if:function(){this.log("暂时未实现")},add:function(){this.log("暂时未实现")},save:function(){this.log("暂时未实现")},save_array:function(){this.log("暂时未实现")},get_array:function(){this.log("暂时未实现")},all:function(){this.log("暂时未实现")},get:function(){this.log("暂时未实现")},drop:function(){this.log("暂时未实现")},search:function(){this.log("暂时未实现")},empty:function(){this.log("暂时未实现")}});var storageBase=new StorageBase;Class("LocalStore",storageBase,{constructor:function(){return 1==this.check_if_not_support()?(console.log('Local storage is not supported by your browser. Please disable "Private Mode", or upgrade to a modern browser.'),void 0):(this.store=store,void 0)},debug:!0,log:function(a){1==debug&&console.log("[LocalStore LOG] "+a)},dump:function(a){1==debug&&console.log("[LocalStore Dump] "+a)},check_if_not_support:function(){return!store.enabled},save_array:function(){var a=JSON.stringify(this.content_arr);this.store.set(this.key,a)},get_array:function(){var a=JSON.parse(store.get(this.key));return a},all:function(){return this.get_array()},get:function(a){var b=this.get_array();return a>=0&&a<=b.length+1?b[a]:(this.log(""+this.key+" index = "+a+"异常"),void 0)},drop:function(){store.remove(this.key)},empty:function(){this.store.set(this.key,"")},check_if_exist:function(){return!0},add_if:function(a){this._add(a)},add:function(a){this._add_force(a)},save:function(){this.save_array()},_add:function(a){return 1==this.check_if_exist()?(console.log("重复不能添加"),void 0):(this.content_arr.push(a),void 0)},_add_force:function(a){this.content_arr.push(a)},check_if_exist:function(){return this.log("暂时未实现"),!1},_is_empty:function(){var a=this.all().length;return 0==a?!0:!1},search:function(a,b){function c(a,b,c,f){return this.sifter=new Sifter(a),e=this.sifter.search(""+c,{fields:[b],sort:[{field:"id",direction:"asc"}],limit:f}),console.log("start---------------------------\n"+e.items),d(e)}function d(a){var b=a,c=[];for(var d in b.items){var e=b.items[d].id,g=f[e];c.push(g)}return console.log(c),c}var e="",f=this.all(),g=this.all();for(var h in a){var i=h,j=a[h],k=g.length;g=c(g,i,j,k)}b(g)}}),LocalStore.clear=function(){store.clear()},Class("WebSQLStore",storageBase,{is_number:function(a){if(!a)return!1;var b=/^\d+(\.\d+)?$/;if(!b.test(a))return!1;try{if(parseFloat(a)!=a)return!1}catch(c){return!1}return!0},get_string:function(a){return"'"+a+"'"}},{key_arr:[],val_arr:[],k_v_pair_arr:[],k_v_equal_arr:[],is_set_table_meta_flag:!1,get_websql_db:function(){return openDatabase("db_ichat","1.0","DB of im",2097152)},exec_sql:function(a,b,c){var d=this.get_websql_db();this.log_sql(a),d.transaction(function(b){b.executeSql(a)},function(){return this.debug&&(alert("exec_sql "+a+" fail"),this.log_sql("fail exec_sql "+a+" ")),c&&c(),0},function(){return b&&b(),1})},exec_sql_with_result:function(a,b){var c=this.get_websql_db();this.log_sql(a),c.transaction(function(c){var d=[];c.executeSql(a,[],function(a,c){for(var e=0;e<c.rows.length;e++){var f=c.rows.item(e);d.push(f)}console.log(d),b(d)},this.sql_error_handler),d=[]})},sql_error_handler:function(){alert("sql 执行出错")},log_sql:function(a){this.debug&&console.log("[SQL LOG] "+a)},_create_table:function(a){var b=this;this.is_exist(function(c){if(b._table_exist=c,0==c){var d=b.key,e=b._get_table_meta(a),f="CREATE TABLE IF NOT EXISTS "+d+" (id INTEGER PRIMARY KEY AUTOINCREMENT,"+e+")";b.exec_sql(f),b._table_exist=!0}})},get_attr_type:function(a,b){var c="string";return"number"==typeof b&&(c=this.is_number(b)?"INTEGER":"REAL"),"string"==typeof b&&(c="STRING"),"undefined"==typeof b&&(c="STRING"),"object"==typeof b&&(b=JSON.stringify(b),c="TEXT"),a+" "+c},_set_table_meta:function(a){var b=[],c=[],d=[],e=[];for(var f in a){var g=a[f];str=this.get_attr_type(f,g),c.push(this.get_string(f)),d.push(this.get_string(g)),b.push(str);var h=f+"="+this.get_string(g);e.push(h)}this.key_arr=c,this.val_arr=d,this.k_v_pair_arr=b,this.k_v_equal_arr=e,this.is_set_table_meta_flag=!0},_get_table_meta:function(a){return this.set_table_meta(a),this.k_v_pair_arr.join(",")},set_table_meta:function(a){0==this.is_set_table_meta_flag?this._set_table_meta(a):this.log("当前表已经设置过meta信息了，或者，表就不存在")},_save:function(a){this._save_with(a)},_save_with:function(a,b,c){var d=this,e=[],f=[];for(var g in a){var h=a[g];e.push(this.get_string(g)),f.push(this.get_string(h))}var i=e.join(","),j=f.join(",");this._is_record_exist(a,function(){this.log("该记录已经存在，不需要插入"),b&&b()},function(){this.log("该记录不存在，准备保存");var a="insert into "+d.key+" ("+i+") values("+j+")";b&&c?d.exec_sql(a,b,c):b?d.exec_sql(a,b,function(){console.log("cb_succ函数存在，但保存失败")}):d.exec_sql(a),this.log("该记录保存完成")})},_is_record_exist:function(a,b,c){this.set_table_meta(a),this._get_record_count(a,function(a){a>0?b():c()})},_get_record_count:function(a,b){this.set_table_meta(a);var c=this.k_v_equal_arr.join(" and "),d="select count(0) as count from "+this.key+" where "+c;this.exec_sql_with_result(d,function(a){b(a[0].count)})},_is_table_exist:function(a){var b="select count(0) as count from sqlite_master where type='table' and name='"+this.key+"'";this.exec_sql_with_result(b,function(b){a(b[0].count)})},_get_all_table_names:function(a){var b="select * from sqlite_master where type='table'";this.exec_sql_with_result(b,function(b){a(b)})}},{constructor:function(a){if(this.key=a,1==this.check_if_not_support())return alert("WebSQLStore is not supported by your browser."),void 0;var b=this;this.is_exist(function(a){b._table_exist=a})},check_if_not_support:function(){return!window.openDatabase},add_if:function(){this.log("暂时未实现")},add:function(a){this._create_table(a),this.content_arr.push(a)},save:function(a,b){return a&&b?(this.save_array(a,b),void 0):a?(this.save_array(a),void 0):(this.save_array(),void 0)},save_array:function(a,b){if(0==this.content_arr.length)return this.log("当前没有需要保存的内容"),a(),void 0;for(var c in this.content_arr){var d=this.content_arr[c];c==this.content_arr.length-1?this._save_with(d,function(){a&&a()},function(){b&&b()}):this._save(d)}},get_array:function(a){return a&&a(this.content_arr),this.content_arr},load_all:function(a){var b="select * from "+this.key;this.exec_sql_with_result(b,function(b){a&&a(b)})},all:function(a){return this.get_array(a)},get:function(a){return this.content_arr[a]},drop:function(a){this.log("执行drop table "+this.key);var b="drop table "+this.key+";",c=this;this.is_exist(function(d){1==d&&c.exec_sql(b),c._table_exist=!1,a&&a()})},empty:function(){this.log("empty table "+this.key);var a="delete from "+this.key+";";this.exec_sql(a)},is_exist:function(a){this._is_table_exist(function(b){1==b?a(!0):a(!1)})},search:function(a,b){var c=this,d=[];for(var e in a){var f=" trim("+e+")='"+a[e]+"'";d.push(f)}var g=d.join(" and "),h="select * from "+this.key+" where "+g;c.exec_sql_with_result(h,function(a){b&&b(a)})}}),Class("Collection",{MEMORY:0,WEBSQL:1,INDEXDB:2,LOCAL_STORAGE:3},LocalStore,CollectionBase,{constructor:function(a){this.key=a,this.engine=this.LOCAL_STORAGE,this.change_engine(),this.content_arr=[]},apply:function(a,b){if(a||(a={}),b)for(var c in b)a[c]=b[c];return a},use_websql:function(){this.engine=this.WEBSQL,this.change_engine()},change_engine:function(){switch(this.engine){case this.WEBSQL:var a=new WebSQLStore(this.key);this.apply(this,a);break;case this.INDEXDB:return new IndexdbDataLayer;case this.LOCAL_STORAGE:var a=new LocalStore(this.key);this.apply(this,a);break;default:return new MemoryDataLayer}}});